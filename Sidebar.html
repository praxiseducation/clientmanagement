<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: 'Poppins', 'Google Sans', Arial, sans-serif;
        margin: 0;
        padding: 15px;
        font-size: 14px;
        background: #f8f9fa;
      }
      
      .user-info {
        background: linear-gradient(135deg, #003366 0%, #1a73e8 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 13px;
      }
      
      .user-name {
        font-weight: 600;
        margin-bottom: 4px;
      }
      
      .user-role {
        opacity: 0.9;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .organization {
        background: #e8f0fe;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 13px;
        border-left: 4px solid #1a73e8;
      }
      
      .org-label {
        font-weight: 500;
        color: #1a73e8;
        margin-bottom: 4px;
      }
      
      .org-name {
        color: #202124;
        font-weight: 600;
      }
      
      .current-client {
        background: white;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 13px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .current-client-label {
        font-weight: 500;
        color: #5f6368;
        margin-bottom: 4px;
      }
      
      .current-client-name {
        color: #202124;
        font-weight: 600;
      }
      
      .no-client {
        color: #5f6368;
        font-style: italic;
      }
      
      .section {
        margin-bottom: 25px;
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .section-title {
        font-weight: 600;
        color: #202124;
        margin-bottom: 12px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .section-icon {
        font-size: 16px;
      }
      
      button {
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #dadce0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      button:hover:not(:disabled) {
        background: #f8f9fa;
        border-color: #1a73e8;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      button:active {
        transform: translateY(0);
        box-shadow: none;
      }
      
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .primary {
        background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
        color: white;
        border: none;
        text-align: center;
        justify-content: center;
      }
      
      .primary:hover:not(:disabled) {
        background: linear-gradient(135deg, #1557b0 0%, #0d47a1 100%);
      }
      
      .admin-only {
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        color: white;
        border: none;
      }
      
      .admin-only:hover:not(:disabled) {
        background: linear-gradient(135deg, #b71c1c 0%, #8e24aa 100%);
      }
      
      .icon {
        font-size: 16px;
        width: 20px;
        text-align: center;
      }
      
      .loading {
        display: none;
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1a73e8;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .message {
        font-size: 13px;
        margin-top: 10px;
        padding: 12px;
        border-radius: 6px;
        display: none;
        border-left: 4px solid;
      }
      
      .error {
        color: #d93025;
        background: #fce8e6;
        border-left-color: #d93025;
      }
      
      .success {
        color: #188038;
        background: #e6f4ea;
        border-left-color: #188038;
      }
      
      .warning {
        color: #ea8600;
        background: #fef7e0;
        border-left-color: #ea8600;
      }
      
      .notification-badge {
        background: #ea4335;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 10px;
        margin-left: auto;
        font-weight: 600;
      }
      
      .rate-limit {
        font-size: 11px;
        color: #5f6368;
        text-align: center;
        margin-top: 5px;
        opacity: 0.8;
      }
      
      /* Legacy mode indicator */
      .legacy-mode {
        background: #fef7e0;
        color: #ea8600;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
        text-align: center;
        margin-bottom: 15px;
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Legacy Mode Warning (shown if enterprise features unavailable) -->
    <div class="legacy-mode" id="legacyMode">
      ‚ö†Ô∏è Running in single-user mode
    </div>
    
    <!-- User Information (Enterprise Mode) -->
    <div class="user-info" id="userInfo" style="display: none;">
      <div class="user-name" id="userName">Not logged in</div>
      <div class="user-role" id="userRole"></div>
    </div>
    
    <!-- Organization Information (Enterprise Mode) -->
    <div class="organization" id="organizationInfo" style="display: none;">
      <div class="org-label">Organization:</div>
      <div class="org-name" id="orgName"></div>
    </div>
    
    <!-- Current Client -->
    <div class="current-client" id="currentClient">
      <div class="current-client-label">Current Client:</div>
      <div id="clientName" class="no-client">Loading...</div>
    </div>
    
    <!-- Client Management Section -->
    <div class="section">
      <div class="section-title">
        <span class="section-icon">üë•</span>
        Client Management
      </div>
      <button class="primary" id="addClientBtn" onclick="handleAddClient()">
        <span class="icon">‚ûï</span>
        Add New Client
      </button>
      <button onclick="handleFindClient()">
        <span class="icon">üîç</span>
        Find Client
      </button>
      <button onclick="handleViewClients()">
        <span class="icon">üìã</span>
        View All Clients
      </button>
      <div class="rate-limit" id="clientRateLimit"></div>
    </div>
    
    <!-- Session Management Section -->
    <div class="section">
      <div class="section-title">
        <span class="section-icon">üìù</span>
        Session Management
      </div>
      <button id="quickNotesBtn" onclick="handleQuickNotes()" disabled>
        <span class="icon">üìù</span>
        Quick Notes
      </button>
      <button id="recapBtn" onclick="handleSendRecap()" disabled>
        <span class="icon">‚úâÔ∏è</span>
        Send Session Recap
      </button>
      <button onclick="handleBatchPrep()">
        <span class="icon">üìã</span>
        Batch Prep Mode
      </button>
      <button onclick="handleViewHistory()">
        <span class="icon">üìä</span>
        View Recap History
      </button>
      <div class="rate-limit" id="emailRateLimit"></div>
    </div>
    
    <!-- Notifications Section (Enterprise Mode) -->
    <div class="section" id="notificationSection" style="display: none;">
      <div class="section-title">
        <span class="section-icon">üîî</span>
        Notifications
        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
      </div>
      <button onclick="handleViewNotifications()">
        <span class="icon">üì¨</span>
        View Notifications
      </button>
      <button onclick="handleMarkNotificationsRead()">
        <span class="icon">‚úì</span>
        Mark All as Read
      </button>
    </div>
    
    <!-- Admin Functions (Enterprise Mode) -->
    <div class="section" id="adminSection" style="display: none;">
      <div class="section-title">
        <span class="section-icon">‚öôÔ∏è</span>
        Administration
      </div>
      <button class="admin-only" onclick="handleSystemDashboard()">
        <span class="icon">üè¢</span>
        System Dashboard
      </button>
      <button class="admin-only" onclick="handleOrgDashboard()">
        <span class="icon">üèóÔ∏è</span>
        Organization Dashboard
      </button>
      <button onclick="handleSystemMaintenance()">
        <span class="icon">üîß</span>
        System Maintenance
      </button>
      <button onclick="handleComplianceReport()">
        <span class="icon">üìã</span>
        Compliance Report
      </button>
    </div>
    
    <!-- Loading State -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Processing...</p>
    </div>
    
    <!-- Messages -->
    <div class="message error" id="error"></div>
    <div class="message success" id="success"></div>
    <div class="message warning" id="warning"></div>
    
    <script>
      let isEnterpriseMode = false;
      let currentUser = null;
      let rateLimits = {};
      
      // Initialize sidebar on load
      function initializeSidebar() {
        // Try to initialize enterprise mode first
        google.script.run
          .withSuccessHandler(handleEnterpriseInit)
          .withFailureHandler(fallbackToLegacyMode)
          .initializeEnterpriseMode();
      }
      
      function handleEnterpriseInit(initData) {
        if (initData && initData.success) {
          isEnterpriseMode = true;
          currentUser = initData.user;
          
          // Show enterprise UI elements
          document.getElementById('userInfo').style.display = 'block';
          document.getElementById('notificationSection').style.display = 'block';
          
          // Update user info
          document.getElementById('userName').textContent = initData.user.displayName || initData.user.email;
          document.getElementById('userRole').textContent = initData.role;
          
          // Show admin section if applicable
          if (initData.role === 'admin' || initData.role === 'supervisor') {
            document.getElementById('adminSection').style.display = 'block';
          }
          
          // Load organization info
          loadOrganizationInfo();
          
          // Load notifications
          updateNotifications();
          
          // Show rate limits
          document.getElementById('clientRateLimit').textContent = 'Limit: 10 per 5 minutes';
          document.getElementById('emailRateLimit').textContent = 'Limit: 20 per hour';
        } else {
          fallbackToLegacyMode();
        }
        
        // Always load current client info
        updateCurrentClient();
      }
      
      function fallbackToLegacyMode() {
        isEnterpriseMode = false;
        document.getElementById('legacyMode').style.display = 'block';
        
        // Hide enterprise-only features
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('organizationInfo').style.display = 'none';
        document.getElementById('notificationSection').style.display = 'none';
        document.getElementById('adminSection').style.display = 'none';
        
        // Load current client info
        updateCurrentClient();
      }
      
      function loadOrganizationInfo() {
        google.script.run
          .withSuccessHandler((result) => {
            if (result && result.organization) {
              document.getElementById('organizationInfo').style.display = 'block';
              document.getElementById('orgName').textContent = 
                result.organization.displayName || result.organization.name;
            }
          })
          .withFailureHandler(() => {})
          .getOrganizationClientList();
      }
      
      function updateCurrentClient() {
        google.script.run
          .withSuccessHandler((clientInfo) => {
            const clientNameDiv = document.getElementById('clientName');
            const quickNotesBtn = document.getElementById('quickNotesBtn');
            const recapBtn = document.getElementById('recapBtn');
            
            if (clientInfo && clientInfo.isClient) {
              clientNameDiv.textContent = clientInfo.name;
              clientNameDiv.className = 'current-client-name';
              quickNotesBtn.disabled = false;
              recapBtn.disabled = false;
            } else {
              clientNameDiv.textContent = 'No client selected';
              clientNameDiv.className = 'no-client';
              quickNotesBtn.disabled = true;
              recapBtn.disabled = true;
            }
          })
          .withFailureHandler(() => {
            document.getElementById('clientName').textContent = 'Error loading client';
            document.getElementById('clientName').className = 'no-client';
          })
          .getCurrentClientInfo();
      }
      
      function updateNotifications() {
        if (!isEnterpriseMode) return;
        
        google.script.run
          .withSuccessHandler((result) => {
            // Expecting result from NotificationManager.getUserNotifications
            const notifications = result || [];
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationCount');
            
            if (unreadCount > 0) {
              badge.textContent = unreadCount;
              badge.style.display = 'inline';
            } else {
              badge.style.display = 'none';
            }
          })
          .withFailureHandler(() => {})
          .getUserNotifications();
      }
      
      // Handler functions that work in both modes
      function handleAddClient() {
        showLoading();
        clearMessages();
        
        const functionName = isEnterpriseMode ? 'showAddClientDialog' : 'addNewClient';
        
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)[functionName]();
      }
      
      function handleFindClient() {
        showLoading();
        clearMessages();
        
        google.script.run
          .withSuccessHandler(() => {
            handleSuccess();
            updateCurrentClient();
          })
          .withFailureHandler(handleError)
          .findClient();
      }
      
      function handleViewClients() {
        showLoading();
        clearMessages();
        
        const functionName = isEnterpriseMode ? 'getAccessibleClientList' : 'showActiveClientsList';
        
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)[functionName]();
      }
      
      function handleQuickNotes() {
        showLoading();
        clearMessages();
        
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .openQuickNotes();
      }
      
      function handleSendRecap() {
        showLoading();
        clearMessages();
        
        const functionName = isEnterpriseMode ? 'sendEmailSecure' : 'sendIndividualRecap';
        
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)[functionName]();
      }
      
      function handleBatchPrep() {
        showLoading();
        clearMessages();
        
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .openBatchPrepMode();
      }
      
      function handleViewHistory() {
        showLoading();
        clearMessages();
        
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .viewRecapHistory();
      }
      
      // Enterprise-only handlers
      function handleViewNotifications() {
        showLoading();
        clearMessages();
        
        google.script.run
          .withSuccessHandler(() => {
            handleSuccess();
            updateNotifications();
          })
          .withFailureHandler(handleError)
          .showNotificationDialog();
      }
      
      function handleMarkNotificationsRead() {
        showLoading();
        clearMessages();
        
        google.script.run
          .withSuccessHandler(() => {
            handleSuccess('All notifications marked as read');
            updateNotifications();
          })
          .withFailureHandler(handleError)
          .markAllNotificationsAsRead();
      }
      
      function handleSystemDashboard() {
        showLoading();
        clearMessages();
        
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .showEnterpriseAdminDashboard();
      }
      
      function handleOrgDashboard() {
        showLoading();
        clearMessages();
        
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .showOrganizationDashboard();
      }
      
      function handleSystemMaintenance() {
        if (confirm('Run system maintenance? This may take a few minutes.')) {
          showLoading();
          clearMessages();
          
          google.script.run
            .withSuccessHandler((result) => {
              handleSuccess(result.message || 'Maintenance completed');
            })
            .withFailureHandler(handleError)
            .runSystemMaintenance();
        }
      }
      
      function handleComplianceReport() {
        const startDate = prompt('Start date (YYYY-MM-DD):');
        const endDate = prompt('End date (YYYY-MM-DD):');
        
        if (startDate && endDate) {
          showLoading();
          clearMessages();
          
          google.script.run
            .withSuccessHandler((report) => {
              handleSuccess(`Report generated with ${report.summary.totalActions} entries`);
            })
            .withFailureHandler(handleError)
            .generateComplianceReportDialog(startDate, endDate);
        }
      }
      
      // Utility functions
      function showLoading() {
        document.getElementById('loading').style.display = 'block';
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = true);
      }
      
      function hideLoading() {
        document.getElementById('loading').style.display = 'none';
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = false);
        
        // Re-check client-dependent buttons
        updateCurrentClient();
      }
      
      function handleSuccess(message) {
        hideLoading();
        if (message) {
          showMessage('success', message);
        }
      }
      
      function handleError(error) {
        hideLoading();
        
        const errorMessage = error.message || error.toString() || 'An error occurred';
        
        // Check for rate limiting
        if (errorMessage.includes('Rate limit')) {
          showMessage('warning', 'Rate limit reached. Please wait before trying again.');
        } else {
          showMessage('error', errorMessage);
        }
      }
      
      function showMessage(type, message) {
        clearMessages();
        const messageDiv = document.getElementById(type);
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 5000);
      }
      
      function clearMessages() {
        ['error', 'success', 'warning'].forEach(type => {
          document.getElementById(type).style.display = 'none';
        });
      }
      
      // Helper function for getting user notifications (enterprise mode)
      function getUserNotifications() {
        if (!isEnterpriseMode || !currentUser) return;
        
        // This would call NotificationManager.getUserNotifications through the server
        return currentUser.email;
      }
      
      // Helper for marking notifications as read
      function markAllNotificationsAsRead() {
        if (!isEnterpriseMode || !currentUser) return;
        
        // This would call NotificationManager.markAllAsRead through the server
        const userId = currentUser.email;
        google.script.run
          .withSuccessHandler(() => updateNotifications())
          .markAllNotificationsAsRead(userId);
      }
      
      // Auto-refresh data periodically
      setInterval(() => {
        updateCurrentClient();
        
        if (isEnterpriseMode) {
          updateNotifications();
        }
      }, 30000); // Every 30 seconds
      
      // Initialize on load
      initializeSidebar();
    </script>
  </body>
</html>