<script>
  // Quick Notes JavaScript - Fixed Version
  
  // Quick Notes initialization
  function initializeQuickNotes() {
    loadClientName();
    loadSavedNotes();
    loadPillButtons();
    setupAutoSave();
  }
  
  // Load client name for display
  function loadClientName() {
    google.script.run
      .withSuccessHandler((clientInfo) => {
        const nameElement = document.getElementById('quickNotesClientName');
        if (nameElement && clientInfo && clientInfo.name) {
          nameElement.textContent = clientInfo.name;
        }
      })
      .withFailureHandler((error) => {
        console.error('Failed to load client name:', error);
      })
      .getCurrentClientInfo();
  }
  
  // Load saved notes from storage
  function loadSavedNotes() {
    google.script.run
      .withSuccessHandler((notesData) => {
        if (notesData && notesData.data) {
          try {
            const notes = JSON.parse(notesData.data);
            // Populate all fields
            Object.keys(notes).forEach(field => {
              const element = document.getElementById(field);
              if (element) {
                element.value = notes[field] || '';
              }
            });
          } catch (e) {
            console.error('Error parsing saved notes:', e);
          }
        }
      })
      .withFailureHandler((error) => {
        console.error('Failed to load saved notes:', error);
      })
      .getQuickNotes();
  }
  
  // Save Quick Notes
  function saveQuickNotes() {
    const notes = {
      wins: document.getElementById('wins').value,
      skillsMastered: document.getElementById('skillsMastered').value,
      skillsPracticed: document.getElementById('skillsPracticed').value,
      skillsIntroduced: document.getElementById('skillsIntroduced').value,
      struggles: document.getElementById('struggles').value,
      parent: document.getElementById('parent').value,
      next: document.getElementById('next').value
    };
    
    google.script.run
      .withSuccessHandler(() => {
        showQuickNotesMessage('Notes saved successfully!', 'success');
      })
      .withFailureHandler((error) => {
        showQuickNotesMessage('Failed to save notes', 'error');
      })
      .saveQuickNotes(notes);
  }
  
  // Clear Quick Notes
  function clearQuickNotes() {
    if (confirm('Are you sure you want to clear all notes?')) {
      const fields = ['wins', 'skillsMastered', 'skillsPracticed', 'skillsIntroduced', 'struggles', 'parent', 'next'];
      fields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
          element.value = '';
        }
      });
      saveQuickNotes();
    }
  }
  
  // Open Session Recap dialog
  function openSessionRecap() {
    // Save notes first
    saveQuickNotes();
    
    // Open recap dialog
    google.script.run
      .withSuccessHandler(() => {
        // Dialog opened successfully
      })
      .withFailureHandler((error) => {
        showQuickNotesMessage('Failed to open recap dialog', 'error');
      })
      .showRecapDialog();
  }
  
  // Load pill buttons for each section
  function loadPillButtons() {
    google.script.run
      .withSuccessHandler((settings) => {
        if (settings) {
          Object.keys(settings).forEach(section => {
            const container = document.getElementById(section + 'Buttons');
            if (container && settings[section]) {
              renderPillButtons(container, settings[section], section);
            }
          });
        }
      })
      .withFailureHandler((error) => {
        console.error('Failed to load pill buttons:', error);
      })
      .getQuickNotesButtons();
  }
  
  // Render pill buttons for a section
  function renderPillButtons(container, buttons, section) {
    container.innerHTML = '';
    buttons.forEach(buttonText => {
      const button = document.createElement('button');
      button.className = 'pill-button';
      button.textContent = buttonText;
      button.onclick = function() {
        togglePillButton(this, section);
      };
      container.appendChild(button);
    });
  }
  
  // Toggle pill button selection
  function togglePillButton(button, section) {
    const textarea = document.getElementById(section);
    if (!textarea) return;
    
    const text = button.textContent;
    const currentValue = textarea.value;
    
    if (button.classList.contains('selected')) {
      // Remove from textarea
      button.classList.remove('selected');
      const regex = new RegExp('•?\\s*' + escapeRegex(text) + '\\s*\n?', 'g');
      textarea.value = currentValue.replace(regex, '').trim();
    } else {
      // Add to textarea
      button.classList.add('selected');
      if (currentValue && !currentValue.endsWith('\n')) {
        textarea.value += '\n';
      }
      textarea.value += '• ' + text + '\n';
    }
    
    // Trigger auto-save
    if (autoSaveTimeout) {
      clearTimeout(autoSaveTimeout);
    }
    autoSaveTimeout = setTimeout(saveQuickNotes, 1000);
  }
  
  // Escape special regex characters
  function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
  
  // Open Quick Notes settings
  function openQuickNotesSettings() {
    google.script.run
      .withSuccessHandler(() => {
        // Settings dialog opened
      })
      .withFailureHandler((error) => {
        showQuickNotesMessage('Failed to open settings', 'error');
      })
      .showQuickNotesSettings();
  }
  
  // Show message in Quick Notes view
  function showQuickNotesMessage(message, type) {
    // Create message element if it doesn't exist
    let messageDiv = document.getElementById('quickNotesMessage');
    if (!messageDiv) {
      messageDiv = document.createElement('div');
      messageDiv.id = 'quickNotesMessage';
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      document.body.appendChild(messageDiv);
    }
    
    // Set message style based on type
    if (type === 'success') {
      messageDiv.style.background = '#e6f4ea';
      messageDiv.style.color = '#188038';
      messageDiv.style.border = '1px solid #188038';
    } else {
      messageDiv.style.background = '#fce8e6';
      messageDiv.style.color = '#d93025';
      messageDiv.style.border = '1px solid #d93025';
    }
    
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
    
    // Auto hide after 3 seconds
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 3000);
  }
  
  // Setup auto-save functionality
  let autoSaveTimeout;
  function setupAutoSave() {
    const textareas = document.querySelectorAll('.notes-textarea');
    textareas.forEach(textarea => {
      textarea.addEventListener('input', () => {
        if (autoSaveTimeout) {
          clearTimeout(autoSaveTimeout);
        }
        autoSaveTimeout = setTimeout(saveQuickNotes, 2000);
      });
    });
  }
  
  // Update pill button selections based on textarea content
  function updatePillButtonSelections() {
    const sections = ['wins', 'skillsMastered', 'skillsPracticed', 'skillsIntroduced', 'struggles', 'parent', 'next'];
    
    sections.forEach(section => {
      const textarea = document.getElementById(section);
      const container = document.getElementById(section + 'Buttons');
      
      if (textarea && container) {
        const content = textarea.value;
        const buttons = container.querySelectorAll('.pill-button');
        
        buttons.forEach(button => {
          const buttonText = button.textContent;
          if (content.includes(buttonText)) {
            button.classList.add('selected');
          } else {
            button.classList.remove('selected');
          }
        });
      }
    });
  }
  
  // Initialize when Quick Notes view is shown
  if (document.getElementById('quickNotesView')) {
    initializeQuickNotes();
  }
</script>