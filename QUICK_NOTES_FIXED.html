<!-- Quick Notes View -->
<div class="quick-notes-container">
  <!-- Back Button -->
  <button class="back-button" onclick="switchToControlPanel()">
    ← Back to Control Panel
  </button>
  
  <!-- Client Name -->
  <h2 id="quickNotesClientName" class="client-name">Loading...</h2>
  
  <!-- Structured Quick Notes Sections -->
  <div class="quick-notes-sections">
    <!-- Wins Section -->
    <div class="notes-section">
      <label class="section-label">Today's Wins</label>
      <textarea id="wins" class="notes-textarea" placeholder="What went well today?" data-color="#4CAF50"></textarea>
      <div id="winsButtons" class="pill-button-container"></div>
    </div>
    
    <!-- Skills Mastered Section -->
    <div class="notes-section">
      <label class="section-label">Skills Mastered</label>
      <textarea id="skillsMastered" class="notes-textarea" placeholder="Skills the student has mastered" data-color="#2196F3"></textarea>
      <div id="skillsMasteredButtons" class="pill-button-container"></div>
    </div>
    
    <!-- Skills Practiced Section -->
    <div class="notes-section">
      <label class="section-label">Skills Practiced</label>
      <textarea id="skillsPracticed" class="notes-textarea" placeholder="Skills practiced during session" data-color="#FF9800"></textarea>
      <div id="skillsPracticedButtons" class="pill-button-container"></div>
    </div>
    
    <!-- Skills Introduced Section -->
    <div class="notes-section">
      <label class="section-label">Skills Introduced</label>
      <textarea id="skillsIntroduced" class="notes-textarea" placeholder="New skills introduced today" data-color="#9C27B0"></textarea>
      <div id="skillsIntroducedButtons" class="pill-button-container"></div>
    </div>
    
    <!-- Struggles Section -->
    <div class="notes-section">
      <label class="section-label">Struggles</label>
      <textarea id="struggles" class="notes-textarea" placeholder="Areas where student struggled" data-color="#F44336"></textarea>
      <div id="strugglesButtons" class="pill-button-container"></div>
    </div>
    
    <!-- Parent Communication Section -->
    <div class="notes-section">
      <label class="section-label">Parent Communication</label>
      <textarea id="parent" class="notes-textarea" placeholder="Notes for parents" data-color="#00BCD4"></textarea>
      <div id="parentButtons" class="pill-button-container"></div>
    </div>
    
    <!-- Next Session Section -->
    <div class="notes-section">
      <label class="section-label">Next Session</label>
      <textarea id="next" class="notes-textarea" placeholder="Plans for next session" data-color="#795548"></textarea>
      <div id="nextButtons" class="pill-button-container"></div>
    </div>
  </div>
  
  <!-- Action Buttons -->
  <div class="button-grid">
    <button class="action-button btn-primary" onclick="saveQuickNotes()">
      Save Notes
    </button>
    <button class="action-button btn-secondary" onclick="openSessionRecap()">
      Send Recap
    </button>
    <button class="action-button btn-secondary" onclick="loadSavedNotes()">
      Reload Saved
    </button>
    <button class="action-button btn-danger" onclick="clearQuickNotes()">
      Clear Notes
    </button>
  </div>
  
  <!-- Settings Button -->
  <button class="settings-button" onclick="openQuickNotesSettings()">
    ⚙️ Settings
  </button>
</div>

<?!= include('frontend/css/quick-notes'); ?>

<script>
  // Quick Notes JavaScript - Inline Version
  
  // Define functions in global scope
  window.saveQuickNotes = function() {
    const notes = {
      wins: document.getElementById('wins').value,
      skillsMastered: document.getElementById('skillsMastered').value,
      skillsPracticed: document.getElementById('skillsPracticed').value,
      skillsIntroduced: document.getElementById('skillsIntroduced').value,
      struggles: document.getElementById('struggles').value,
      parent: document.getElementById('parent').value,
      next: document.getElementById('next').value
    };
    
    google.script.run
      .withSuccessHandler(() => {
        showQuickNotesMessage('Notes saved successfully!', 'success');
      })
      .withFailureHandler((error) => {
        showQuickNotesMessage('Failed to save notes', 'error');
        console.error(error);
      })
      .saveQuickNotes(notes);
  }
  
  window.clearQuickNotes = function() {
    if (confirm('Are you sure you want to clear all notes?')) {
      const fields = ['wins', 'skillsMastered', 'skillsPracticed', 'skillsIntroduced', 'struggles', 'parent', 'next'];
      fields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
          element.value = '';
        }
      });
      saveQuickNotes();
    }
  }
  
  window.loadSavedNotes = function() {
    google.script.run
      .withSuccessHandler((notesData) => {
        if (notesData && notesData.data) {
          try {
            const notes = JSON.parse(notesData.data);
            Object.keys(notes).forEach(field => {
              const element = document.getElementById(field);
              if (element) {
                element.value = notes[field] || '';
              }
            });
            showQuickNotesMessage('Notes loaded!', 'success');
          } catch (e) {
            console.error('Error parsing saved notes:', e);
          }
        }
      })
      .withFailureHandler((error) => {
        console.error('Failed to load saved notes:', error);
      })
      .getQuickNotes();
  }
  
  window.openSessionRecap = function() {
    // Save notes first
    saveQuickNotes();
    
    // Open recap dialog
    google.script.run
      .withSuccessHandler(() => {
        // Dialog opened successfully
      })
      .withFailureHandler((error) => {
        showQuickNotesMessage('Failed to open recap dialog', 'error');
      })
      .showRecapDialog();
  }
  
  window.openQuickNotesSettings = function() {
    google.script.run
      .withSuccessHandler(() => {
        // Settings dialog opened
      })
      .withFailureHandler((error) => {
        showQuickNotesMessage('Failed to open settings', 'error');
      })
      .showQuickNotesSettings();
  }
  
  function showQuickNotesMessage(message, type) {
    // Create message element if it doesn't exist
    let messageDiv = document.getElementById('quickNotesMessage');
    if (!messageDiv) {
      messageDiv = document.createElement('div');
      messageDiv.id = 'quickNotesMessage';
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      document.body.appendChild(messageDiv);
    }
    
    // Set message style based on type
    if (type === 'success') {
      messageDiv.style.background = '#e6f4ea';
      messageDiv.style.color = '#188038';
      messageDiv.style.border = '1px solid #188038';
    } else {
      messageDiv.style.background = '#fce8e6';
      messageDiv.style.color = '#d93025';
      messageDiv.style.border = '1px solid #d93025';
    }
    
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
    
    // Auto hide after 3 seconds
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 3000);
  }
  
  function initializeQuickNotes() {
    // Load client name
    google.script.run
      .withSuccessHandler((clientInfo) => {
        const nameElement = document.getElementById('quickNotesClientName');
        if (nameElement && clientInfo && clientInfo.name) {
          nameElement.textContent = clientInfo.name;
        }
      })
      .withFailureHandler((error) => {
        console.error('Failed to load client name:', error);
      })
      .getCurrentClientInfo();
    
    // Load saved notes
    loadSavedNotes();
    
    // Load pill buttons
    google.script.run
      .withSuccessHandler((settings) => {
        if (settings) {
          Object.keys(settings).forEach(section => {
            const container = document.getElementById(section + 'Buttons');
            if (container && settings[section]) {
              renderPillButtons(container, settings[section], section);
            }
          });
        }
      })
      .withFailureHandler((error) => {
        console.error('Failed to load pill buttons:', error);
      })
      .getQuickNotesButtons();
    
    // Setup auto-save
    const textareas = document.querySelectorAll('.notes-textarea');
    textareas.forEach(textarea => {
      textarea.addEventListener('input', () => {
        if (window.autoSaveTimeout) {
          clearTimeout(window.autoSaveTimeout);
        }
        window.autoSaveTimeout = setTimeout(saveQuickNotes, 2000);
      });
    });
  }
  
  function renderPillButtons(container, buttons, section) {
    container.innerHTML = '';
    buttons.forEach(buttonText => {
      const button = document.createElement('button');
      button.className = 'pill-button';
      button.textContent = buttonText;
      button.onclick = function() {
        togglePillButton(this, section);
      };
      container.appendChild(button);
    });
  }
  
  function togglePillButton(button, section) {
    const textarea = document.getElementById(section);
    if (!textarea) return;
    
    const text = button.textContent;
    const currentValue = textarea.value;
    
    if (button.classList.contains('selected')) {
      // Remove from textarea
      button.classList.remove('selected');
      const regex = new RegExp('•?\\s*' + text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*\n?', 'g');
      textarea.value = currentValue.replace(regex, '').trim();
    } else {
      // Add to textarea
      button.classList.add('selected');
      if (currentValue && !currentValue.endsWith('\n')) {
        textarea.value += '\n';
      }
      textarea.value += '• ' + text + '\n';
    }
    
    // Trigger auto-save
    if (window.autoSaveTimeout) {
      clearTimeout(window.autoSaveTimeout);
    }
    window.autoSaveTimeout = setTimeout(saveQuickNotes, 1000);
  }
  
  // Initialize when this view is shown
  initializeQuickNotes();
</script>